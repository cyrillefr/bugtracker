<!doctype html>
<html data-ng-app="bugTracker" >
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Node + Angular Bug Tracker app</title>       
        <link href="/stylesheets/style.css" rel="stylesheet" type="text/css">
        <!-- Bootstrap core CSS -->
        <link href="/stylesheets/bootstrap/bootstrap.css" rel="stylesheet" type="text/css">
        <!-- Custom styles for this template -->
        <style>
            body {
                padding-top: 50px;
            }
            .starter-template {
                padding: 40px 15px;
                text-align: center;
            }
    
    </style>

    </head>
    <body >


    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">(Really) tiny bug tracker</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Home</a></li>
                    <li><a href="#myView">My view</a></li>
                    <li><a href="#stats">Stats</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>

        <div class="container" ng-controller="listCtrl" >
            <table>            
                <tr ng-if="titles.length > 0" ng-repeat="y in titles">
                    <td ng-class="myVar" ng-mouseover="myVar='not-selected'" ng-mouseleave="myVar='selected'">
                        {{ y.title  }}  {{ y.description  }}
                    </td>
                </tr>
                <tr ng-if="titles.length == 0">
                    <td>
                        no data                    
                    </td>                
                </tr>
            </table>
        </div>

        <form name="formNewBug" ng-controller="insertCtrl" >
        <div class="container" >    
            <input type='text' ng-model='newBug.title' />  
            <textarea ng-model='newBug.description'></textarea>
            <input type='button' ng-click='addBug()'  value='Add bug ...' />
            
        </div>
        </form>


        <!-- MAIN CONTENT AND INJECTED VIEWS -->
        <div id="main">
         

            <!-- angular templating -->
            <!-- this is where content will be injected -->
            <div ng-view></div>
        </div>

        <!--  logique scripts a mettre ds une seule page-->
        <script src="/javascripts/angular/angular.js"></script>
        <script src="/javascripts/angular/angular-route.js"></script>
        <script src="/javascripts/angular/ui-bootstrap.js"></script>
        <script src="/javascripts/core.js"></script>
        <script src="module.js"></script>
        <script src="controllers.js"></script>
        <script>


      

            appBugTracker.controller('listCtrl', function($scope, $http, $rootScope, $timeout) {
                
                $scope.loadData = function () {
                    $http.get('/models/bugs_list.js').
                    then(function(response) {
                        $scope.titles = response.data;                
                    }, function(response) {
            
                    });
                };

                //initial load
                $scope.loadData();

                //On this event, reload datas
                $scope.$on('BUG_INSERTED_IN_LIST', function () {
                    $timeout(function(){
                        $scope.loadData();
                    }, 0, false) ;
                })
            });

            appBugTracker.controller('insertCtrl', function($scope, $http, $rootScope) {

                //form datas                
                $scope.newBug = {};         
       
    
                $scope.addBug = function (){
                    var postData = {};
  
                    //decouple form name - db name ???
                   //  mongoose ?
                    // no control/update for now to form datas but it should
                    postData = this.newBug;
         
                    
                    $http.post('/models/insert_bug.js', postData).
                        then(function(response) {
                            //vide le formulaire
                            $scope.newBug = {};
                            $rootScope.$broadcast('BUG_INSERTED_IN_LIST'); 
                        }, function(response) {
            
                    });
                };

            });

            </script>
    </body>
</html>
